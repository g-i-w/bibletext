<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8' />
<title>Interlinear Bible</title>
<style>
	body {
		font-family:sans-serif;
		font-size:14px;
		border:0;
		margin:0;
		padding:0;
	}
	div {
		margin:8px 0 8px 0;
		min-height:20px;
		display:inline-block;
		min-width:200px;
		max-width:500px;
		vertical-align:top;
	}
	.main-div {
		background-color:#fafafa;
		visibility:hidden;		
	}
	.controls-subdiv {
		margin:0 8px 0 8px;
	}
	#controlsDiv {
		margin-top:0;
		padding:16px 0 16px 0;
	}
	input {
		padding: 4px 8px;
		margin: 4px 0;
		display: inline-block;
		border: 1px solid #ccc;
		border-radius: 4px;
		box-sizing: border-box;
	}
	table {
		border-collapse:collapse;
		border:0;
	}
	td {
		border-top:solid 1px lightgray;
		padding:4px;
	}
	td table td {
		border-top:0;
	}
	
	.highlighted {
		color:white;
		background-color:#004080;
		border:0;
		padding:2px;
	}
	a {
		color:#004080;
	}
	a.highlighted {
		font-weight:bold;
		border-radius:2px;
	}
	td.highlighted, .highlighted td {
		color:black;
		border-top:0;
		margin-bottom:4px;
		background-color:#f0f0f0;
	}

</style>
</head>
<body>
	<center>
	
	<div id="controlsDiv" style="max-width:100%;width:100%;">
	<div class="controls-subdiv">
	Verse: <input id="book" onchange="refresh()" value="GEN" style="width:80px;">&nbsp;&nbsp;<input id="chap" onchange="refresh()" value="1" style="width:40px;">:<input id="verse" onchange="refresh()" value="1" style="width:40px;"> <br>
	</div>
	<div class="controls-subdiv">
	Word: <input id="word" onchange="refresh()" value="בְּרֵאשִׁ֖ית">
	</div>
	</div>
	<a id="verseView"></a>
	
	<div id="verseDiv" class="main-div"></div>
	
	<div id="wordDiv" class="main-div"></div>
	<a id="wordView"></a>
	
	<br>
	<div id="loadingDiv"><h1>Loading...</h1></div>
	
	</center>
	
<script src="interlinear.js"></script>	
<script>

	const verseHistory = {};
	const wordHistory = {};

	// building-block functions

	function getId ( id ) {
		return document.getElementById( id );
	}
	
	function getVal ( id ) {
		return getId( id ).value;
	}
	
	function setVal ( id, val ) {
		//console.log( 'setting '+id+' to '+val );
		var prev = getId( id ).value;
		getId( id ).value = val;
		return prev;
	}
	
	function basicChar ( c ) {
		// check for substitute greek char
		if ('άᾳᾴᾶᾷὰάἀἁἂἃἄἅἆᾄᾅ'.indexOf( c ) > -1) return 'α';
		if ('ἈἉἋἌἍἎ'.indexOf( c ) > -1) return 'Α';
		if ('έἐἑἓἔἕ'.indexOf( c ) > -1) return 'ε';
		if ('ἘἙἛἜἝ'.indexOf( c ) > -1) return 'Ε';
		if ('ἨἩἪἫἬἭἮ'.indexOf( c ) > -1) return 'Η';
		if ('ϊΐὶίίῒΐῖἰἱἳἴἵἶἷ'.indexOf( c ) > -1) return 'ι';
		if ('ἸἹἼἽ'.indexOf( c ) > -1) return 'Ι';
		if ('όὸόὀὁὂὃὄὅ'.indexOf( c ) > -1) return 'ο';
		if ('ὈὉὋὌὍ'.indexOf( c ) > -1) return 'Ο';
		if ('ΰῦῢὐὑὒὓὔὕὖὗ'.indexOf( c ) > -1) return 'υ';
		if ('ὙὝὟ'.indexOf( c ) > -1) return 'Υ';
		if ('ώῳῴῶῷᾠᾧὠὡὢὤὥὦὧὼώ'.indexOf( c ) > -1) return 'ω';
		if ('ὨὩὪὬὭὮὯᾯ'.indexOf( c ) > -1) return 'Ω';
		if ('ἐἑἓἔἕὲέέ'.indexOf( c ) > -1) return 'ε';
		if ('ύϋὺύ'.indexOf( c ) > -1) return 'ν';
		if ('ὴήῃῄῆῇᾐᾑᾔᾖᾗήἠἡἢἣἤἥἦἧ'.indexOf( c ) > -1) return 'η';
		if ('ῥ'.indexOf( c ) > -1) return 'ρ';
		if ('Ῥ'.indexOf( c ) > -1) return 'Ρ';
		
		// check for basic greek char
		if ('᾽’ΑαΒβΓγΔδΕεΖζΗηΘθΙιΚκΛλΜμΝνΞξΟοΠπΡρΣσςΤτΥυΦφΧχΨψΩω'.indexOf( c ) > -1) return c;
		
		// check for basic hebrew char
		if ('אבגדהוזחטיךכלםמןנסעףפץצקרשתװױײ׳״־׀׃׆'.indexOf( c ) > -1) return c;
		
		// otherwise return nothing
		return '';
	}
	
	function basicWord ( word ) {
		var basic = '';
		for (let i = 0; i < word.length; i++) {
			basic += basicChar( word[i] );
		}
		return basic;
	}
	
	function substringSet ( word ) {
		var wordLength = word.length;
		var set = new Set();
		
		for (let size=wordLength-1; size>=1; size--) {
			let maxPos = wordLength-size; // max start-index of substring
			for (let pos=0; pos<=maxPos; pos++) {
				let subWord = word.substring(pos, pos+size);
				set.add( subWord );
			}
		}
		return set;
	}

	function wordHash ( key ) {
		let len = key.length;
		if (len <= 2) return key;
		return key.substring( 0, 1 )+key.substring( len-1, len ); // first+last
	}




	// structural functions

	function verseText ( bibleObj, book, chap, verse ) {
		//console.log( 'verseText: '+book+','+chap+','+verse );
		if (bibleObj!==undefined && bibleObj[book]!==undefined && bibleObj[book][chap]!==undefined) {
			return bibleObj[book][chap][verse];
		} else {
			//return `[NOT FOUND: ${book} ${chap}:${verse}]`;
			return '';
		}
	}
	
	function exactWord ( text, basic ) {
		//console.log( text );
		var html = '';
		if (text!==undefined) {
			for (let word of text.split(/\s+/)) {
				if (basicWord( word )==basic) html += " <a href=\"#wordView\" onclick=\"changeWord('"+word+"')\">"+word+"</a>";
			}
		}
		return html;
	}
	
	function strongsInfo ( word ) {
		var basicToCode = interlinear.strongs.basicToCode;
		var codeToReplacement = interlinear.strongs.codeToReplacement;
		var basic = basicWord( word );
		var hash = wordHash( basic );
		var html = '<table>';
		if (basicToCode[hash]!==undefined && basicToCode[hash][basic]!==undefined) {
			for (const [code, codeObj] of Object.entries(basicToCode[hash][basic])) {
				let codeHash = code.substring(0,3);
				if (codeToReplacement[codeHash]!==undefined && codeToReplacement[codeHash][code]!==undefined) {
					for (const [rep, repObj] of Object.entries(codeToReplacement[codeHash][code])) {
						html += "<tr><td>"+code+"</td><td>"+rep+"</td></tr>";
					}
				}
			}
		}
		html += '</table>';
		return html;
	}
	
	function verseLink ( book, chap, verse ) {
		if ( getVal("book")==book && getVal("chap")==chap && getVal("verse")==verse )
			return `<a href="#verseView" onclick="changeVerse('${book}','${chap}','${verse}')" class="highlighted">${book} ${chap}:${verse}</a>`;
		else
			return `<a href="#verseView" onclick="changeVerse('${book}','${chap}','${verse}')">${book} ${chap}:${verse}</a>`;
	}
	
	function wordLink ( word ) {
		if ( basicWord(getVal( "word" )) == basicWord(word) )
			return `<a href="#wordView" onclick="changeWord('${word}')" class="highlighted">${word}</a>`;
		else
			return `<a href="#wordView" onclick="changeWord('${word}')">${word}</a>`;
	}
	
	function wordInfo ( word ) {
		var basic = basicWord( word );
		var hash = wordHash( basic );
		
		// history
		var html = '<table><tr><td colspan=2 class="highlighted">';
		var delim = '';
		for (const [key, nullObj] of Object.entries(wordHistory)) {
			html += delim+wordLink( key );
			delim = '&nbsp; ';
		}
		html += '</td></tr>';

		// word info
		//var html = '<table>';
		html += '<tr><td class="highlighted"><h1>'+basic+'</h1></td><td class="highlighted">'+strongsInfo( word )+'</td></tr>';
		//html += '</table>';
		
		// word locations
		//html += '<table>';
		if (interlinear.data[hash]!==undefined && interlinear.data[hash][basic]!==undefined) {
			for (const [book, bookObj] of Object.entries(interlinear.data[hash][basic])) {
				html += '<tr><td>'+book+'</td><td>';
				let delim = '';
				for (const [chap, chapObj] of Object.entries(bookObj)) {
					for (const [verse, verseOjb] of Object.entries(chapObj)) {
						let text = verseText( interlinear.text, book, chap, verse );
						//console.log( text );
						//html += '<tr><td>'+book+'</td><td>'+chap+"</td><td><a href=\"#\" onclick=\"changeVerse('"+book+"','"+chap+"','"+verse+"')\">"+verse+'</a></td><td>'+exactWord( text, basic )+'</td></tr>';
						//html += delim+"<a href=\"#verseView\" onclick=\"changeVerse('"+book+"','"+chap+"','"+verse+"')\">"+chap+':'+verse+'</a>';
						html += delim+verseLink( book, chap, verse );
						delim = ' , ';
					}
				}
				html += '</td></tr>';
			}
		}
		//html += '</table>';
		
		// sub-word info
		//html += '<table>';
		for (let sub of substringSet( basic )) {
			let subHash = wordHash( sub );
			if (interlinear.data[subHash]!==undefined && interlinear.data[subHash][sub]!==undefined) {
				html += "<tr><td><a href=\"#wordView\" onclick=\"changeWord('"+sub+"')\">"+sub+"</a></td><td>"+strongsInfo( sub )+"</td></tr>";
			}
		}
		html += '</table>';
		
		return html;
	}
	
	function verseInfo ( book, chap, verse ) {
		var html = '<table><tr><td colspan=2 class="highlighted">';
		var delim = '';
		for (const [key, verseObj] of Object.entries(verseHistory)) {
			html += delim+verseLink( verseObj.book, verseObj.chap, verseObj.verse );
			delim = '&nbsp; ';
		}
		html += '</td></tr>';
		for (const [tCode, bibleObj] of Object.entries(interlinear.translations)) {
			html += '<tr><td class="highlighted">'+tCode+'</td><td class="highlighted">'+verseText( bibleObj, book, chap, verse )+'</td></tr>';
		}
		var text = verseText( interlinear.text, book, chap, verse );
		for (let word of text.split(/\s+/)) {
			html += '<tr><td>'+wordLink( word )+'</td><td>'+strongsInfo( word )+'</td></tr>';
		}
		html += '</table>';
		return html;
	}
	
	function changeVerse ( book, chap, verse ) {
		setVal( "book", book );
		setVal( "chap", chap );
		setVal( "verse", verse );
		refresh();
	}

	function changeWord ( word ) {
		setVal( "word", word );
		refresh();
	}
	
	function refresh () {

		// verse inputs
		var book = getVal( "book" );
		var chap = getVal( "chap" );
		var verse = getVal( "verse" );

		// word input
		var word = getVal( "word" );

		// history
		verseHistory[book+chap+verse] = { book:book, chap:chap, verse:verse };
		wordHistory[word] = null;
		
		// refresh divs
		getId( "verseDiv" ).innerHTML = verseInfo( book, chap, verse );
		getId( "wordDiv" ).innerHTML = wordInfo( word );
	}
	
	refresh();
	getId( "verseDiv" ).style.visibility = 'visible';
	getId( "wordDiv" ).style.visibility = 'visible';
	getId( "loadingDiv" ).style.visibility = 'hidden';

</script>
</body>
</html>

